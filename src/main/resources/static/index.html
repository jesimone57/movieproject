<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Juliet Movie Project</title>
  <style>
    :root {
      --bg: #f7fafc;
      --card: #ffffff;
      --text: #2d3748;
      --muted: #718096;
      --primary: #4a90e2;
      --primary-dark: #347acc;
      --border: #e2e8f0;
      --chip: #edf2f7;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      color: var(--text);
      background: linear-gradient(180deg, #fbfdff 0%, var(--bg) 100%);
    }

    header {
      padding: 28px 20px 10px;
      text-align: center;
    }
    h1 {
      margin: 0 0 6px;
      font-size: 28px;
      letter-spacing: 0.3px;
    }
    .subtitle { color: var(--muted); font-size: 14px; }

    .container { max-width: 1140px; margin: 0 auto; padding: 16px; }

    .panel {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.04);
    }

    /* Removed resizable panels to allow full page flow without internal scrollbars */

    .grid {
      display: grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 12px;
      align-items: end;
    }

    label { display: block; font-size: 12px; color: var(--muted); margin-bottom: 6px; }

    input, select {
      width: 100%;
      padding: 10px 12px;
      font-size: 14px;
      color: var(--text);
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 8px;
      outline: none;
      transition: box-shadow 0.15s ease, border-color 0.15s ease;
    }
    input:focus, select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(74,144,226,0.15); }

    /* Value-highlight state for inputs when they contain a value */
    input.has-value {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(74,144,226,0.15);
    }

    /* Compact field helpers */
    .compact-select {
      width: auto; /* shrink to fit content */
      display: inline-block;
      white-space: nowrap;
    }
    .small-input {
      width: 86px; /* ~fits 4 digits comfortably */
      display: inline-block;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      border: 1px solid var(--primary);
      background: var(--primary);
      color: white;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.15s ease, transform 0.05s ease;
      text-decoration: none;
      white-space: nowrap;
    }
    .btn.secondary { background: #fff; color: var(--primary); }
    .btn:hover { background: var(--primary-dark); }
    .btn.secondary:hover { background: #f5f9ff; }
    .btn:active { transform: translateY(1px); }
    .btn:disabled { opacity: 0.6; cursor: progress; }

    .actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }

    .results {
      margin-top: 18px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }

    .table-wrap { overflow: auto; border: 1px solid var(--border); border-radius: 12px; background: var(--card); }
    table { border-collapse: collapse; width: 100%; min-width: 880px; }
    /* Tighten column spacing a bit for a denser look */
    th, td { padding: 8px 10px; border-bottom: 1px solid var(--border); text-align: left; font-size: 14px; }
    th { background: #f1f5f9; font-weight: 700; color: #334155; position: sticky; top: 0; }
    tbody tr:hover { background: #f9fbfd; }

    .row { display: contents; }
    /* Right-align numeric table cells for clean column alignment */
    .numcol { text-align: right; font-variant-numeric: tabular-nums; white-space: nowrap; }
    /* Allow wrapping in numeric column headers to tighten column width */
    th.numcol { white-space: normal; }
    /* Sortable header controls */
    .sortable { display: inline-flex; align-items: center; gap: 2px; }
    /* Stack sort arrows vertically to save horizontal space */
    .sort-controls {
      display: inline-flex;
      flex-direction: column;
      gap: 1px;           /* reduce vertical gap between arrows */
      align-items: center;
      margin-left: 2px;   /* keep arrows very close to label */
    }
    .sort-controls button {
      padding: 0 3px; line-height: 1; height: 14px; min-width: 16px;
      border: 1px solid transparent; border-radius: 4px; background: transparent; color: #64748b;
      cursor: pointer; font-size: 12px;
    }
    .sort-controls button:hover { background: #e2e8f0; color: #334155; }
    .sort-controls button.active { background: #dbeafe; border-color: #bfdbfe; color: #1d4ed8; font-weight: 700; }
    .kpi {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      background: var(--chip);
      font-size: 12px;
    }

    /* Revenue cell layout: ensure the ROI pill fits and hugs the right edge neatly */
    .roi-cell { display: flex; justify-content: flex-end; align-items: center; width: 100%; }
    /* ROI highlight box styles for Revenue column */
    .roi {
      display: inline-flex;
      align-items: center;
      /* Add right padding for breathing room; compensate with negative right margin to keep right edge alignment */
      padding: 4px 8px 4px 10px; /* top right bottom left */
      margin-right: -8px;        /* maintain alignment with Budget column */
      border-radius: 16px;       /* a bit rounder for a better fit */
      line-height: 1.4;
      white-space: nowrap;
      font-variant-numeric: tabular-nums; /* consistent digit widths */
      /* Use inset box-shadow as a border so it doesn't affect layout width */
      box-shadow: inset 0 0 0 2px transparent;
    }
    .roi-green { box-shadow: inset 0 0 0 3px #16a34a; background: rgba(22,163,74,0.10); }
    .roi-yellow { box-shadow: inset 0 0 0 3px #f59e0b; background: rgba(245,158,11,0.10); }
    .roi-red { box-shadow: inset 0 0 0 3px #dc2626; background: rgba(220,38,38,0.10); }

    /* Title column width (70% of previous 320px setting = ~224px) */
    /* Column order (current): 1:#, 2:Title, 3:Year, 4:IMDb, 5:Director, 6:Actors, 7:Genre, 8:Duration, 9:Oscars Nom., 10:Oscars Won, 11:Oscars Won Details, 12:MPAA, 13:AFI, 14:IMDB URL */
    th:nth-child(2), td:nth-child(2) { min-width: 224px; }

    /* Make the Oscars Nominated column a little narrower */
    th:nth-child(9), td:nth-child(9) { width: 80px; }

    pre.json { background: #0b1020; color: #d6eaff; padding: 16px; border-radius: 12px; overflow: auto; font-size: 13px; }
    code.key { color: #8be9fd }
    code.str { color: #f1fa8c }
    code.num { color: #bd93f9 }
    code.bool { color: #50fa7b }
    code.null { color: #ff79c6 }

    .section-title { font-weight: 700; margin: 6px 2px 2px; font-size: 15px; color: #334155; }

    .note { color: var(--muted); font-size: 12px; }

    .footer { text-align: center; color: var(--muted); font-size: 12px; padding: 18px; }
  </style>
</head>
<body>
  <header>
    <h1>Juliet Movie Project</h1>
    <div class="subtitle">A lightweight UI to exercise the MovieController API</div>
  </header>

  <div class="container">
    <div class="panel">
      <div class="section-title">Filters</div>
      <div class="grid" style="margin-top:8px">
        <div class="col" style="grid-column: span 4;">
          <label for="title">Title contains</label>
          <input id="title" type="text" placeholder="e.g. Star" />
        </div>
        <div class="col" style="grid-column: span 3;">
          <label for="director">Director contains</label>
          <input id="director" type="text" placeholder="e.g. Hitchcock" />
        </div>
        <div class="col" style="grid-column: span 3;">
          <label for="actor">Actor contains</label>
          <input id="actor" type="text" placeholder="e.g. Gable, Hepburn" />
        </div>
        <div class="col" style="grid-column: span 3;">
          <label for="genre">Genre(s) (comma-separated)</label>
          <input id="genre" type="text" placeholder="e.g. Action, Adventure" />
        </div>
        <!-- Min rating moved up next to Genre(s) and made compact -->
        <div class="col" style="grid-column: span 1;">
          <label for="minRating">Min IMDb rating</label>
          <input id="minRating" type="text" placeholder="7.5" class="small-input" />
        </div>
        <!-- Year start/end made compact to fit 4-digit years -->
        <div class="col" style="grid-column: span 1;">
          <label for="yearStart">Year start</label>
          <input id="yearStart" type="number" inputmode="numeric" placeholder="1990" class="small-input" />
        </div>
        <div class="col" style="grid-column: span 1;">
          <label for="yearEnd">Year end</label>
          <input id="yearEnd" type="number" inputmode="numeric" placeholder="2020" class="small-input" />
        </div>
        <!-- Sort by defaults to title and is compact; (none) removed -->
        <div class="col" style="grid-column: span 1;">
          <label for="sort">Sort by</label>
          <select id="sort" class="compact-select">
            <option value="title" selected>title</option>
            <option value="year">year</option>
            <option value="rating">rating</option>
          </select>
        </div>
        <!-- Clear button placed after Sort by -->
        <div class="col" style="grid-column: span 1; display:flex; align-items:end;">
          <button class="btn secondary" id="btnClear" title="Clear all filters">Clear</button>
        </div>
      </div>

      <div class="section-title" style="margin-top:14px">API Actions</div>
      <div class="actions">
        <button class="btn" id="btnSearch">Search</button>
        <button class="btn secondary" id="btnTopN">Top Rated</button>
      </div>
      
    </div>

    <div class="results">
      <div class="panel">
        <div class="section-title">Results</div>
        <div id="kpis" style="margin:8px 0 12px 0; display:flex; gap:8px; flex-wrap:wrap;"></div>
        <div id="results"></div>
      </div>
    </div>

    <div class="footer">Powered by http://localhost:8080/api/movies</div>
  </div>

  <script>
    const api = (path, params) => {
      const base = 'http://localhost:8080';
      const url = new URL(base + path);
      if (params) Object.entries(params).forEach(([k, v]) => {
        if (v !== undefined && v !== null && v !== '') url.searchParams.set(k, v);
      });
      return fetch(url, { headers: { 'Accept': 'application/json' } });
    };

    const el = id => document.getElementById(id);

    function showLoading(button, loading=true) {
      if (!button) return;
      if (loading) {
        button.dataset.label = button.textContent;
        button.textContent = 'Loading…';
        button.disabled = true;
      } else {
        button.textContent = button.dataset.label || 'Done';
        button.disabled = false;
      }
    }

    function formatJSON(obj) {
      // Simple syntax highlighter for JSON
      const json = JSON.stringify(obj, null, 2)
        .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
        .replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, match => {
          let cls = 'num';
          if (/^"/.test(match)) {
            cls = /:$/.test(match) ? 'key' : 'str';
          } else if (/true|false/.test(match)) {
            cls = 'bool';
          } else if (/null/.test(match)) {
            cls = 'null';
          }
          return '<code class="' + cls + '">' + match + '</code>';
        });
      return `<pre class="json">${json}</pre>`;
    }

    // In-memory cache and sorting state for client-side sorting
    let lastResults = [];
    let currentSort = null; // { key: string, dir: 'asc'|'desc' }

    // Parse strings like "98%" into numeric 98 for proper sorting
    function parsePercent(val) {
      if (val === null || val === undefined) return null;
      if (typeof val === 'number') return val;
      const s = String(val).trim();
      if (!s) return null;
      const n = parseFloat(s.replace('%', ''));
      return Number.isNaN(n) ? null : n;
    }

    function getSortValue(m, key) {
      switch (key) {
        case 'title': return (m.title ?? '').toString();
        case 'year': return (m.year ?? null);
        case 'imdb': return (m.imdbRating ?? null);
        case 'budget': return (m.budget_usd_millions ?? m.budget ?? null);
        case 'revenue': return (m.gross_revenue_usd_millions ?? m.revenue ?? null);
        case 'rt_critic': {
          const v = m.ratings && (m.ratings.rotten_tomatoes_critic ?? m.ratings.rottenTomatoesCritic);
          return parsePercent(v);
        }
        case 'rt_popcorn': {
          const v = m.ratings && (m.ratings.rotten_tomatoes_popcorn ?? m.ratings.rottenTomatoesPopcorn);
          return parsePercent(v);
        }
        case 'director': {
          const dname = m.director && (m.director.name ?? m.director?.Name);
          return (dname ?? '').toString();
        }
        case 'actors': {
          if (Array.isArray(m.actors)) {
            // Sort by a single comparable string of actor names
            return m.actors
              .map(a => (a && (a.name ?? a?.Name) ? String(a.name ?? a?.Name) : ''))
              .filter(Boolean)
              .join(', ');
          }
          return '';
        }
        case 'genre': {
          if (Array.isArray(m.genres)) return m.genres.join(', ').toString();
          return (m.genres ?? '').toString();
        }
        case 'duration': return (m.runtime_minutes ?? null);
        case 'osc_nom': return (m.oscars_nominated ?? null);
        case 'osc_won': return (m.oscars_won ?? null);
        case 'osc_won_details': {
          if (Array.isArray(m.oscars_won_details)) {
            return m.oscars_won_details.join(', ');
          }
          return '';
        }
        case 'mpaa': return (m.mpaa_rating ?? '').toString();
        case 'afi': return (m.afi_ranking ?? m.afiRanking ?? null);
        default: return null;
      }
    }

    function compareValues(a, b) {
      // Handle null/undefined: push to end in ascending
      const na = (a === null || a === undefined || a === '');
      const nb = (b === null || b === undefined || b === '');
      if (na && nb) return 0;
      if (na) return 1;
      if (nb) return -1;
      const an = typeof a === 'number';
      const bn = typeof b === 'number';
      if (an && bn) return a - b;
      // Try to coerce numeric strings
      const ap = parseFloat(a);
      const bp = parseFloat(b);
      if (!Number.isNaN(ap) && !Number.isNaN(bp) && String(a).trim() !== '' && String(b).trim() !== '') {
        return ap - bp;
      }
      return String(a).localeCompare(String(b), undefined, { sensitivity: 'base' });
    }

    // Format numeric million values with consistent decimals for visual alignment
    function formatMillions(val) {
      if (val === null || val === undefined || val === '') return '';
      const n = Number(val);
      if (Number.isNaN(n)) return '';
      // Allow 0–2 decimals depending on data precision
      return n.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 2 });
    }

    function sortData(data, key, dir) {
      const sorted = data.slice().sort((m1, m2) => {
        const v1 = getSortValue(m1, key);
        const v2 = getSortValue(m2, key);
        const base = compareValues(v1, v2);
        return dir === 'desc' ? -base : base;
      });
      return sorted;
    }

    function setActiveSortIndicators(root) {
      const buttons = root.querySelectorAll('button.sort');
      buttons.forEach(btn => {
        const key = btn.getAttribute('data-key');
        const dir = btn.getAttribute('data-dir');
        const isActive = currentSort && currentSort.key === key && currentSort.dir === dir;
        btn.classList.toggle('active', !!isActive);
      });
    }

    function wireSortHandlers(root) {
      const buttons = root.querySelectorAll('button.sort');
      buttons.forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          const key = btn.getAttribute('data-key');
          const dir = btn.getAttribute('data-dir');
          currentSort = { key, dir };
          if (Array.isArray(lastResults)) {
            const data = sortData(lastResults, key, dir);
            renderInto(el('results'), data);
          }
        });
      });
    }

    // Determine ROI highlight class based on revenue vs budget
    function roiClass(budget, revenue) {
      if (budget == null || revenue == null || isNaN(budget) || isNaN(revenue) || budget <= 0) return '';
      const ratio = Number(revenue) / Number(budget);
      if (ratio >= 2) return 'roi roi-green';
      if (ratio >= 1) return 'roi roi-yellow';
      return 'roi roi-red';
    }

    function renderRevenueCell(m) {
      const rev = (m.gross_revenue_usd_millions ?? m.revenue ?? null);
      const bud = (m.budget_usd_millions ?? m.budget ?? null);
      if (rev == null || rev === '') return '';
      const cls = roiClass(bud, rev);
      const text = escapeHtml(formatMillions(rev));
      return cls ? `<span class="${cls}">${text}</span>` : text;
    }

    function renderMovies(movies) {
      if (!Array.isArray(movies)) return formatJSON(movies);
      const rows = movies.map(m => `
      <tr>
        <td>${m.num ?? ''}</td>
        <td title="${m.description ? escapeAttr(m.description) : ''}">${escapeHtml(m.title ?? '')}</td>
        <td>${m.year ?? ''}</td>
        <td><span class="kpi">${m.imdbRating ?? ''}</span></td>
        <td class="numcol">${(m.ratings && (m.ratings.rotten_tomatoes_critic ?? m.ratings.rottenTomatoesCritic)) || ''}</td>
        <td class="numcol">${(m.ratings && (m.ratings.rotten_tomatoes_popcorn ?? m.ratings.rottenTomatoesPopcorn)) || ''}</td>
        <td>${(m.director && m.director.name) ? (m.director.imdb_person_url ? `<a href="${escapeAttr(m.director.imdb_person_url)}" target="_blank">${escapeHtml(m.director.name)}</a>` : escapeHtml(m.director.name)) : ''}</td>
        <td>${Array.isArray(m.actors) ? m.actors.map(a => {
          const name = a && a.name ? escapeHtml(a.name) : '';
          const url = a && a.imdb_person_url ? escapeAttr(a.imdb_person_url) : null;
          return name ? (url ? `<a href="${url}" target="_blank">${name}</a>` : name) : '';
        }).filter(Boolean).join(', ') : ''}</td>
        <td>${Array.isArray(m.genres) ? m.genres.map(g => escapeHtml(g)).join(', ') : (m.genres ?? '')}</td>
        <td class="numcol">${m.runtime_minutes != null ? escapeHtml(m.runtime_minutes) + ' min' : ''}</td>
        <td class="numcol">${m.oscars_nominated ?? ''}</td>
        <td class="numcol">${m.oscars_won ?? ''}</td>
        <td>${Array.isArray(m.oscars_won_details) ? m.oscars_won_details.map(d => escapeHtml(d)).join('; ') : ''}</td>
        <td>${m.mpaa_rating ?? ''}</td>
        <td class="numcol">${m.afi_ranking ?? m.afiRanking ?? ''}</td>
        <td class="numcol">${formatMillions(m.budget_usd_millions ?? m.budget)}</td>
        <td class="numcol"><div class="roi-cell">${renderRevenueCell(m)}</div></td>
        <td>${m.imdb_url ? `<a href="${escapeAttr(m.imdb_url)}" target="_blank">link</a>` : ''}</td>
      </tr>`).join('');
    return `
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>
                <div class="sortable"><span>Title</span>
                  <span class="sort-controls">
                    <button class="sort" data-key="title" data-dir="asc" title="Sort ascending">▲</button>
                    <button class="sort" data-key="title" data-dir="desc" title="Sort descending">▼</button>
                  </span>
                </div>
              </th>
              <th>
                <div class="sortable"><span>Year</span>
                  <span class="sort-controls">
                    <button class="sort" data-key="year" data-dir="asc" title="Sort ascending">▲</button>
                    <button class="sort" data-key="year" data-dir="desc" title="Sort descending">▼</button>
                  </span>
                </div>
              </th>
              <th>
                <div class="sortable"><span>IMDb</span>
                  <span class="sort-controls">
                    <button class="sort" data-key="imdb" data-dir="asc" title="Sort ascending">▲</button>
                    <button class="sort" data-key="imdb" data-dir="desc" title="Sort descending">▼</button>
                  </span>
                </div>
              </th>
              <th>
                <div class="sortable"><span>Critic</span>
                  <span class="sort-controls">
                    <button class="sort" data-key="rt_critic" data-dir="asc" title="Sort ascending">▲</button>
                    <button class="sort" data-key="rt_critic" data-dir="desc" title="Sort descending">▼</button>
                  </span>
                </div>
              </th>
              <th>
                <div class="sortable"><span>Popcorn</span>
                  <span class="sort-controls">
                    <button class="sort" data-key="rt_popcorn" data-dir="asc" title="Sort ascending">▲</button>
                    <button class="sort" data-key="rt_popcorn" data-dir="desc" title="Sort descending">▼</button>
                  </span>
                </div>
              </th>
              <th>
                <div class="sortable"><span>Director</span>
                  <span class="sort-controls">
                    <button class="sort" data-key="director" data-dir="asc" title="Sort ascending">▲</button>
                    <button class="sort" data-key="director" data-dir="desc" title="Sort descending">▼</button>
                  </span>
                </div>
              </th>
              <th>
                <div class="sortable"><span>Actors</span>
                  <span class="sort-controls">
                    <button class="sort" data-key="actors" data-dir="asc" title="Sort ascending">▲</button>
                    <button class="sort" data-key="actors" data-dir="desc" title="Sort descending">▼</button>
                  </span>
                </div>
              </th>
              <th>
                <div class="sortable"><span>Genre</span>
                  <span class="sort-controls">
                    <button class="sort" data-key="genre" data-dir="asc" title="Sort ascending">▲</button>
                    <button class="sort" data-key="genre" data-dir="desc" title="Sort descending">▼</button>
                  </span>
                </div>
              </th>
              <th class="numcol">
                <div class="sortable"><span>Duration</span>
                  <span class="sort-controls">
                    <button class="sort" data-key="duration" data-dir="asc" title="Sort ascending">▲</button>
                    <button class="sort" data-key="duration" data-dir="desc" title="Sort descending">▼</button>
                  </span>
                </div>
              </th>
              <th class="numcol">
                <div class="sortable"><span>Oscars Nom.</span>
                  <span class="sort-controls">
                    <button class="sort" data-key="osc_nom" data-dir="asc" title="Sort ascending">▲</button>
                    <button class="sort" data-key="osc_nom" data-dir="desc" title="Sort descending">▼</button>
                  </span>
                </div>
              </th>
              <th class="numcol">
                <div class="sortable"><span>Oscars<br>Won</span>
                  <span class="sort-controls">
                    <button class="sort" data-key="osc_won" data-dir="asc" title="Sort ascending">▲</button>
                    <button class="sort" data-key="osc_won" data-dir="desc" title="Sort descending">▼</button>
                  </span>
                </div>
              </th>
              <th>
                <div class="sortable"><span>Oscars Won Details</span>
                  <span class="sort-controls">
                    <button class="sort" data-key="osc_won_details" data-dir="asc" title="Sort ascending">▲</button>
                    <button class="sort" data-key="osc_won_details" data-dir="desc" title="Sort descending">▼</button>
                  </span>
                </div>
              </th>
              <th>
                <div class="sortable"><span>MPAA</span>
                  <span class="sort-controls">
                    <button class="sort" data-key="mpaa" data-dir="asc" title="Sort ascending">▲</button>
                    <button class="sort" data-key="mpaa" data-dir="desc" title="Sort descending">▼</button>
                  </span>
                </div>
              </th>
              <th class="numcol">
                <div class="sortable"><span>AFI</span>
                  <span class="sort-controls">
                    <button class="sort" data-key="afi" data-dir="asc" title="Sort ascending">▲</button>
                    <button class="sort" data-key="afi" data-dir="desc" title="Sort descending">▼</button>
                  </span>
                </div>
              </th>
              <th class="numcol">
                <div class="sortable"><span>Budget</span>
                  <span class="sort-controls">
                    <button class="sort" data-key="budget" data-dir="asc" title="Sort ascending">▲</button>
                    <button class="sort" data-key="budget" data-dir="desc" title="Sort descending">▼</button>
                  </span>
                </div>
              </th>
              <th class="numcol">
                <div class="sortable"><span>Revenue</span>
                  <span class="sort-controls">
                    <button class="sort" data-key="revenue" data-dir="asc" title="Sort ascending">▲</button>
                    <button class="sort" data-key="revenue" data-dir="desc" title="Sort descending">▼</button>
                  </span>
                </div>
              </th>
              <th>IMDB URL</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      </div>`;
    }

    function renderInto(container, data) {
      // Render and then attach sort handlers + highlight active
      container.innerHTML = renderMovies(data);
      wireSortHandlers(container);
      setActiveSortIndicators(container);
    }

    function escapeHtml(s) {
      return String(s)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }
    function escapeAttr(s) { return escapeHtml(s); }

    function setKPIs(listCount, raw) {
      const k = el('kpis');
      const parts = [];
      if (typeof listCount === 'number') parts.push(kpi(`${listCount} item${listCount!==1?'s':''}`));
      if (raw && typeof raw === 'object' && !Array.isArray(raw)) parts.push(kpi(`${Object.keys(raw).length} keys`));
      k.innerHTML = parts.join('');
    }
    function kpi(text) { return `<span class="kpi">${escapeHtml(text)}</span>`; }

    async function handle(button, fn) {
      try { showLoading(button, true); await fn(); }
      catch (e) { el('results').innerHTML = `<div class="panel" style="border-color:#fecaca;background:#fff1f2;color:#7f1d1d">Error: ${escapeHtml(e.message || String(e))}</div>`; }
      finally { showLoading(button, false); }
    }

    // Wire buttons
    el('btnSearch').addEventListener('click', () => handle(el('btnSearch'), async () => {
      const params = {
        q: el('title').value.trim(),
        // default sort is 'title' per requirement
        sort: el('sort').value || 'title',
        genre: el('genre').value.trim() || undefined,
        director: el('director').value.trim() || undefined,
        actor: el('actor').value.trim() || undefined,
        minRating: el('minRating').value ? Number(el('minRating').value) : undefined,
        yearStart: el('yearStart').value ? Number(el('yearStart').value) : undefined,
        yearEnd: el('yearEnd').value ? Number(el('yearEnd').value) : undefined,
      };
      const r = await api('/api/movies/search', params);
      const data = await r.json();
      if (Array.isArray(data)) {
        lastResults = data.slice();
        const toRender = currentSort ? sortData(lastResults, currentSort.key, currentSort.dir) : lastResults;
        renderInto(el('results'), toRender);
        setKPIs(toRender.length, data);
      } else {
        el('results').innerHTML = renderMovies(data);
        setKPIs(undefined, data);
      }
    }));

    el('btnTopN').addEventListener('click', () => handle(el('btnTopN'), async () => {
      const limit = 10; // default top rated count
      const r = await api(`/api/movies/toprating/${encodeURIComponent(limit)}`);
      const data = await r.json();
      if (Array.isArray(data)) {
        lastResults = data.slice();
        const toRender = currentSort ? sortData(lastResults, currentSort.key, currentSort.dir) : lastResults;
        renderInto(el('results'), toRender);
        setKPIs(toRender.length, data);
      } else {
        el('results').innerHTML = renderMovies(data);
        setKPIs(undefined, data);
      }
    }));

    // Optional: Load initial data
    // document.getElementById('btnAll').click();

    // Clear button: reset all inputs and visual state
    el('btnClear').addEventListener('click', () => {
      el('title').value = '';
      el('director').value = '';
      el('actor').value = '';
      el('genre').value = '';
      el('minRating').value = '';
      el('yearStart').value = '';
      el('yearEnd').value = '';
      el('sort').value = 'title';

      // remove results and KPIs
      el('results').innerHTML = '';
      el('kpis').innerHTML = '';

      // update value-highlights
      refreshValueHighlights();
    });

    // Add blue outline when inputs contain values
    function applyValueHighlight(input) {
      if (!input) return;
      const hasValue = input.value != null && String(input.value).trim() !== '';
      input.classList.toggle('has-value', hasValue);
    }
    function refreshValueHighlights() {
      ['title','director','actor','genre','minRating','yearStart','yearEnd'].forEach(id => applyValueHighlight(el(id)));
    }
    ['title','director','actor','genre','minRating','yearStart','yearEnd'].forEach(id => {
      const node = el(id);
      node.addEventListener('input', () => applyValueHighlight(node));
      node.addEventListener('change', () => applyValueHighlight(node));
    });
    // initialize on load
    refreshValueHighlights();
  </script>
</body>
<html>
