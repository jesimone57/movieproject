<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Actor Filmographies</title>
  <style>
    :root {
      --bg: #f7fafc;
      --card: #ffffff;
      --text: #1f2937;
      --muted: #6b7280;
      --primary: #4a90e2;
      --primary-dark: #3579c8;
      --border: #e5e7eb;
      --chip: #eef2f7;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      color: var(--text);
      background: linear-gradient(180deg, #fbfdff 0%, var(--bg) 100%);
    }

    header { padding: 28px 16px 8px; text-align: center; }
    h1 { margin: 0 0 6px; font-size: 26px; letter-spacing: .2px; }
    .subtitle { color: var(--muted); font-size: 14px; }

    .container { max-width: 1140px; margin: 0 auto; padding: 16px; }

    .panel {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.04);
    }

    .grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 12px; align-items: end; }
    label { display: block; font-size: 12px; color: var(--muted); margin-bottom: 6px; }

    input, select { width: 100%; padding: 10px 12px; font-size: 14px; color: var(--text); background: #fff; border: 1px solid var(--border); border-radius: 8px; outline: none; transition: box-shadow .15s ease, border-color .15s ease; }
    input:focus, select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(74,144,226,0.15); }

    .btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 14px; border: 1px solid var(--primary); background: var(--primary); color: #fff; border-radius: 10px; font-weight: 600; cursor: pointer; transition: background .15s ease, transform .05s ease; text-decoration: none; white-space: nowrap; }
    .btn.secondary { background: #fff; color: var(--primary); }
    .btn:hover { background: var(--primary-dark); }
    .btn.secondary:hover { background: #f5f9ff; }
    .btn:active { transform: translateY(1px); }

    .actions { display: flex; flex-wrap: wrap; gap: 8px; }
    .actions-row { display: flex; justify-content: space-between; align-items: center; gap: 12px; margin-top: 8px; }
    .actions-right { display: flex; align-items: center; gap: 8px; }
    .actions-right label { margin: 0; }

    .results { margin-top: 18px; display: grid; grid-template-columns: 1fr; gap: 12px; }
    .table-wrap { overflow: auto; border: 1px solid var(--border); border-radius: 12px; background: var(--card); }
    table { border-collapse: collapse; width: 100%; min-width: 880px; }
    th, td { padding: 8px 10px; border-bottom: 1px solid var(--border); text-align: left; font-size: 14px; }
    th { background: #f1f5f9; font-weight: 700; color: #334155; position: sticky; top: 0; }
    tbody tr:hover { background: #f9fbfd; }
    .numcol { text-align: right; font-variant-numeric: tabular-nums; white-space: nowrap; }
    /* Allow wrapping inside numeric headers so we can split labels across two lines */
    th.numcol { white-space: normal; }

    .sortable { display: inline-flex; align-items: center; gap: 4px; }
    .sort-controls { display: inline-flex; flex-direction: column; gap: 1px; align-items: center; margin-left: 2px; }
    .sort-controls button { padding: 0 3px; line-height: 1; height: 14px; min-width: 16px; border: 1px solid transparent; border-radius: 4px; background: transparent; color: #64748b; cursor: pointer; font-size: 12px; }
    .sort-controls button:hover { background: #e2e8f0; color: #334155; }
    .sort-controls button.active { background: #dbeafe; border-color: #bfdbfe; color: #1d4ed8; font-weight: 700; }

    .note { color: var(--muted); font-size: 12px; }
    .footer { text-align: center; color: var(--muted); font-size: 12px; padding: 18px; }

    /* Column sizing tweaks per updated requirements */
    /* 1: Name, 2: Life (Bornâ€“Died), 3: Oscars Nominated, 4: Oscars Won, 5: Filmography */
    th:nth-child(1), td:nth-child(1) { min-width: 195px; }
    th:nth-child(2), td:nth-child(2) { width: 80px; }                /* compact life span */
    th:nth-child(3), td:nth-child(3) { width: 60px; }                /* Small twoâ€‘digit numbers */
    th:nth-child(4), td:nth-child(4) { width: 60px; }                /* Small twoâ€‘digit numbers */
    th:nth-child(5), td:nth-child(5) { width: 75%; }                 /* Make filmography column wider */

    /* Filmography cell: show each film on a separate line with light spacing */
    .film-line + .film-line { margin-top: 4px; }

    /* KPI pill (copied to match index.html look) */
    .kpi {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      background: var(--chip);
      font-size: 12px;
    }

    /* Award emphasis */
    .oscar-win { color: #0a7a20; font-weight: 700; }
    .oscar-nom { color: #0b5ed7; font-weight: 700; }
  </style>
</head>
<body>
  <header>
    <h1>Actor Filmographies</h1>
    <div class="subtitle">Search actors and view their filmography and awards</div>
  </header>

  <main class="container">
    <section class="panel">
      <div class="grid">
        <div style="grid-column: span 4;">
          <label for="name">Actor Name</label>
          <input id="name" type="text" placeholder="e.g., James Stewart" />
        </div>
        <div style="grid-column: span 2;">
          <label for="year">Year</label>
          <input id="year" type="number" inputmode="numeric" placeholder="e.g., 1946" />
        </div>
        <div style="grid-column: span 3;">
          <label for="oscarsNominated">Oscars Nominated</label>
          <input id="oscarsNominated" type="number" inputmode="numeric" placeholder="e.g., 5" />
        </div>
        <div style="grid-column: span 3;">
          <label for="oscarsWon">Oscars Won</label>
          <input id="oscarsWon" type="number" inputmode="numeric" placeholder="e.g., 1" />
        </div>
      </div>
      <div class="actions-row">
        <div class="actions">
          <button id="searchBtn" class="btn" title="Search">ðŸ”Ž Search</button>
          <button id="clearBtn" class="btn secondary" title="Clear filters">âœ– Clear</button>
          <span id="resultCount" class="kpi" style="display:none"></span>
        </div>
        <div class="actions-right">
          <label for="sort">Sort Filmographies By</label>
          <select id="sort">
            <option value="title" selected>Title</option>
            <option value="year">Year</option>
            <option value="rating">Rating</option>
          </select>
        </div>
      </div>

      <div class="results">
        <div class="table-wrap">
          <table id="resultsTable">
            <colgroup>
              <col style="width: 18%">   <!-- Name -->
              <col style="width: 5%">    <!-- Life (Bornâ€“Died) -->
              <col style="width: 2%">    <!-- Oscars Nominated (2-digit) -->
              <col style="width: 2%">    <!-- Oscars Won (2-digit) -->
              <col style="width: 73%">   <!-- Filmography (wider) -->
            </colgroup>
            <thead>
              <tr>
                <th>
                  <span class="sortable">Name
                    <span class="sort-controls">
                      <button data-col="name" data-dir="asc">â–²</button>
                      <button data-col="name" data-dir="desc">â–¼</button>
                    </span>
                  </span>
                </th>
                <th class="numcol">
                  <span class="sortable">Life
                    <span class="sort-controls">
                      <button data-col="life" data-dir="asc">â–²</button>
                      <button data-col="life" data-dir="desc">â–¼</button>
                    </span>
                  </span>
                </th>
                <th class="numcol">
                  <span class="sortable">Oscars<br>Nominated
                    <span class="sort-controls">
                      <button data-col="noms" data-dir="asc">â–²</button>
                      <button data-col="noms" data-dir="desc">â–¼</button>
                    </span>
                  </span>
                </th>
                <th class="numcol">
                  <span class="sortable">Oscars<br>Won
                    <span class="sort-controls">
                      <button data-col="won" data-dir="asc">â–²</button>
                      <button data-col="won" data-dir="desc">â–¼</button>
                    </span>
                  </span>
                </th>
                <th>Filmography</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
        <div id="status" class="note"></div>
      </div>
    </section>

    <p class="note">Tip: Use the sort arrows in the headers. The Search button requests the server, Clear removes filters and results.</p>
  </main>

  <footer class="footer">Built for ActorFilmographyController â€¢ /api/filmographies/search</footer>

  <script>
    const api = '/api/filmographies/search';
    let data = [];
    let sortState = { col: null, dir: null };

    // Helpers
    const $ = (id) => document.getElementById(id);

    function buildQuery() {
      const params = new URLSearchParams();
      const name = $('name').value.trim();
      const year = $('year').value.trim();
      const noms = $('oscarsNominated').value.trim();
      const won = $('oscarsWon').value.trim();
      const sort = ($('sort')?.value || 'title').trim();
      if (name) params.set('name', name);
      if (year) params.set('year', year);
      if (noms) params.set('oscarsNominated', noms);
      if (won) params.set('oscarsWon', won);
      // Always include sort, default to 'title'
      params.set('sort', sort || 'title');
      return params.toString() ? api + '?' + params.toString() : api;
    }

    function fmt(val, fallback = '') { return (val ?? '') === '' ? fallback : val; }
    function num(val) { return val == null ? null : Number(val); }

    function escapeHtml(s) {
      return String(s)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    // Highlight Oscar awards inside the perâ€‘film awards text
    // Examples to highlight:
    //  - "Oscar: Win â€“ Best Actor" => bold green (oscar-win)
    //  - "Oscar: Nomination â€“ Best Actor" => bold blue (oscar-nom)
    // Non-Oscar awards remain unstyled.
    function highlightAwards(raw) {
      if (!raw || typeof raw !== 'string') return '';
      // Split on semicolons to preserve each award token
      const tokens = raw.split(';');
      const out = tokens.map((tok) => {
        const t = tok.trim();
        if (t.length === 0) return '';
        const hasOscar = /\boscars?\b/i.test(t);
        if (!hasOscar) {
          return escapeHtml(t);
        }
        const isWin = /\bwin(s)?\b/i.test(t);
        const isNom = /\bnomination|nominated\b/i.test(t);
        const safe = escapeHtml(t);
        if (isWin) return `<span class="oscar-win">${safe}</span>`;
        if (isNom) return `<span class="oscar-nom">${safe}</span>`;
        // If it's an Oscar but neither win nor nomination matched, just return escaped
        return safe;
      });
      // Rejoin with semicolons and spaces, mirroring input style
      return out.join('; ');
    }

    function filmToHtml(f) {
      if (!f) return '';
      const title = escapeHtml(fmt(f.title, 'Untitled'));
      const year = (f.year != null) ? ` (${escapeHtml(f.year)})` : '';
      const plot = f.plot ? ` â€” ${escapeHtml(f.plot)}` : '';
      const awards = f.awards ? ` â€” Awards: ${highlightAwards(String(f.awards))}` : '';
      const r = f.ratings || {};
      const parts = [];
      if (typeof r.imdb === 'number') parts.push(`IMDb ${r.imdb.toFixed(1)}`);
      if (r.rottenRomatoesCriticScore) parts.push(`RT Critic ${escapeHtml(r.rottenRomatoesCriticScore)}`);
      if (r.rottenTomatoesPopcornScore) parts.push(`RT Popcorn ${escapeHtml(r.rottenTomatoesPopcornScore)}`);
      const ratings = parts.length ? ` â€” Ratings: ${parts.join(', ')}` : '';
      return `<strong>${title}</strong>${year}${plot}${awards}${ratings}`;
    }

    function aggregateFilmographyHtml(entry) {
      const films = Array.isArray(entry.filmography) ? entry.filmography : [];
      if (!films.length) return '';
      return films.map(f => `<div class="film-line">${filmToHtml(f)}</div>`).join('');
    }

    // Sort each actor's filmography list in-place by the provided key: 'title' | 'year' | 'rating'
    function sortFilmographiesInPlace(sortKeyRaw) {
      const sortKey = String(sortKeyRaw || 'title').toLowerCase();
      const collator = new Intl.Collator(undefined, { sensitivity: 'base' });

      // Precompute comparators for film entries
      const cmp = {
        title: (a, b) => {
          const ta = (a?.title ?? '').toString();
          const tb = (b?.title ?? '').toString();
          return collator.compare(ta, tb);
        },
        year: (a, b) => {
          const ya = (a?.year ?? null);
          const yb = (b?.year ?? null);
          if (ya == null && yb == null) return 0;
          if (ya == null) return -1; // nulls first (matches backend)
          if (yb == null) return 1;
          return ya - yb; // ascending
        },
        rating: (a, b) => {
          const ra = (a?.ratings && typeof a.ratings.imdb === 'number') ? a.ratings.imdb : -Infinity;
          const rb = (b?.ratings && typeof b.ratings.imdb === 'number') ? b.ratings.imdb : -Infinity;
          if (ra === rb) return 0;
          return rb - ra; // descending
        }
      };

      const comparator = cmp[sortKey] || cmp.title;
      if (!Array.isArray(data)) return;
      for (const entry of data) {
        if (!entry || !Array.isArray(entry.filmography)) continue;
        entry.filmography.sort(comparator);
      }
    }

    function lifeSpan(p) {
      const born = p.year_born ?? p.yearBorn ?? null;
      const died = p.year_died ?? p.yearDied ?? null;
      if (born == null && died == null) return '';
      if (born != null && died == null) return `${born}â€“`;
      if (born == null && died != null) return `â€“${died}`;
      return `${born}â€“${died}`;
    }

    function render() {
      const tbody = $('tbody');
      tbody.innerHTML = '';
      const rows = (data || []);
      for (const it of rows) {
        const p = it.actor_profile || it.actorProfile || {}; // support JSON naming
        const awards = p.actor_awards || p.actorAwards || {};
        const tr = document.createElement('tr');
        const cells = [
          fmt(p.name, ''),
          lifeSpan(p),
          awards.oscars_nominated ?? awards.oscarsNominated ?? '',
          awards.oscars_won ?? awards.oscarsWon ?? '',
          aggregateFilmographyHtml(it)
        ];
        cells.forEach((c, idx) => {
          const td = document.createElement('td');
          if (idx === 4) {
            td.innerHTML = c || '';
          } else {
            td.textContent = c === null ? '' : c;
          }
          if (idx >= 1 && idx <= 3) td.classList.add('numcol');
          // Awards coloring: won -> bold green, else if nominated -> bold blue
          if (idx === 2 || idx === 3) {
            const n = Number(c);
            if (!Number.isNaN(n) && n > 0) {
              if (idx === 3) {
                td.classList.add('oscar-win');
              } else {
                // Only apply nomination color if no wins (wins take precedence visually in adjacent cell)
                td.classList.add('oscar-nom');
              }
            }
          }
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      }
      updateActiveSortButtons();
    }

    function compare(a, b, col) {
      const pA = a.actor_profile || a.actorProfile || {};
      const pB = b.actor_profile || b.actorProfile || {};
      const awA = pA.actor_awards || pA.actorAwards || {};
      const awB = pB.actor_awards || pB.actorAwards || {};
      let va, vb;
      switch (col) {
        case 'name': va = (pA.name || '').toLowerCase(); vb = (pB.name || '').toLowerCase(); break;
        case 'life': va = pA.year_born ?? pA.yearBorn ?? null; vb = pB.year_born ?? pB.yearBorn ?? null; break; // sort by birth year
        case 'noms': va = awA.oscars_nominated ?? awA.oscarsNominated ?? null; vb = awB.oscars_nominated ?? awB.oscarsNominated ?? null; break;
        case 'won':  va = awA.oscars_won ?? awA.oscarsWon ?? null;       vb = awB.oscars_won ?? awB.oscarsWon ?? null; break;
        default: va = 0; vb = 0;
      }
      const isNum = typeof va === 'number' || typeof vb === 'number';
      if (isNum) { va = num(va); vb = num(vb); }
      if (va == null && vb == null) return 0;
      if (va == null) return -1;
      if (vb == null) return 1;
      if (isNum) return va - vb;
      return va.localeCompare(vb);
    }

    function sortData(col, dir) {
      if (!col || !dir) return;
      sortState = { col, dir };
      data.sort((a, b) => {
        const r = compare(a, b, col);
        return dir === 'asc' ? r : -r;
      });
      render();
    }

    function updateActiveSortButtons() {
      document.querySelectorAll('.sort-controls button').forEach(btn => {
        const active = sortState.col === btn.dataset.col && sortState.dir === btn.dataset.dir;
        btn.classList.toggle('active', active);
      });
    }

    function setResultCount(n) {
      const rc = $('resultCount');
      if (typeof n === 'number') {
        rc.textContent = `${n} result${n === 1 ? '' : 's'}`;
        rc.style.display = 'inline-block';
      } else {
        rc.textContent = '';
        rc.style.display = 'none';
      }
    }

    async function search() {
      const url = buildQuery();
      const status = $('status');
      status.textContent = 'Searchingâ€¦';
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        data = await res.json();
        // Ensure filmography rows reflect the current dropdown immediately
        sortFilmographiesInPlace($('sort')?.value || 'title');
        // If a sort is already selected, re-apply; otherwise default sort by name asc
        if (sortState.col && sortState.dir) {
          sortData(sortState.col, sortState.dir);
        } else {
          sortData('name', 'asc');
        }
        status.textContent = `${data.length} result(s)`;
        setResultCount(data.length);
      } catch (e) {
        console.error(e);
        data = [];
        render();
        status.textContent = 'Search failed: ' + e.message;
        setResultCount(null);
      }
    }

    function clearFilters() {
      $('name').value = '';
      $('year').value = '';
      $('oscarsNominated').value = '';
      $('oscarsWon').value = '';
      if ($('sort')) $('sort').value = 'title';
      data = [];
      sortState = { col: null, dir: null };
      $('tbody').innerHTML = '';
      $('status').textContent = '';
      updateActiveSortButtons();
      setResultCount(null);
      // After clearing, immediately perform the default search to repopulate results
      // Default search = no filters, sort title, and default actor sort by name asc
      search();
    }

    // Events
    document.querySelectorAll('.sort-controls button').forEach(btn => {
      btn.addEventListener('click', () => sortData(btn.dataset.col, btn.dataset.dir));
    });
    $('searchBtn').addEventListener('click', search);
    $('clearBtn').addEventListener('click', clearFilters);

    // Change of filmography sort should immediately re-render without a new fetch
    $('sort').addEventListener('change', () => {
      sortFilmographiesInPlace($('sort').value);
      render();
    });

    // Allow Enter to trigger search
    ['name','year','oscarsNominated','oscarsWon','sort'].forEach(id => {
      $(id).addEventListener('keydown', (e) => { if (e.key === 'Enter') search(); });
    });

    // Optional: perform an initial load (empty filters fetches all if backend supports it)
    // search();
  </script>
</body>
</html>
